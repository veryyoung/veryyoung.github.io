<!doctype html><html class=""><head>
<meta data-react-helmet="true" charset="utf-8"/><meta data-react-helmet="true" http-equiv="x-ua-compatible" content="ie=edge"/><meta data-react-helmet="true" name="description" content="Web3 Builder&amp;Crypto Holder"/><meta data-react-helmet="true" name="viewport" content="width=device-width, initial-scale=1"/><meta data-react-helmet="true" property="og:title" content="Optimistic Rollup 原理分析 · veryyoung&#x27;s blog"/><meta data-react-helmet="true" property="og:description" content="Web3 Builder&amp;Crypto Holder"/><meta data-react-helmet="true" property="og:type" content="article"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:site" content="@0xveryyoung"/>
<title data-react-helmet="true">Optimistic Rollup 原理分析 · veryyoung&#x27;s blog</title>
<link data-react-helmet="true" rel="stylesheet" href="/assets/index.css"/><link data-react-helmet="true" id="prismTheme" rel="stylesheet" href="/assets/prism.css"/>
<script data-react-helmet="true" >
    const shouldSetIsDark = document.cookie.includes('is_dark=1') ? true : document.cookie.includes('is_dark=0') ? false : window.matchMedia('(prefers-color-scheme: dark)').matches;
    if (shouldSetIsDark) {
      document.documentElement.classList.add('is_dark');
      document.getElementById('prismTheme').href = "/assets/prism_tomorrow.css";
    }
  </script>
</head><body><a class="czs-menu-l show_on_mobile aside_button_open" href="#" style="background-image:url(&quot;/assets/czs-menu-l.svg&quot;)"></a><a class="show_on_mobile aside_button_text" href="/">veryyoung&#x27;s blog</a><aside class="hide_on_mobile"><div class="aside_card"><a class="czs-menu-l show_on_mobile aside_button_close" href="#" style="background-image:url(&quot;/assets/czs-close-l.svg&quot;)"></a><h1><a href="/">veryyoung&#x27;s blog</a></h1><p class="description">Web3 Builder&amp;Crypto Holder</p><ul class="social list_style_none"><li class="flex_center"><a class="czs-github-logo" href="https://github.com/veryyoung" target="_blank" style="background-image:url(&quot;/assets/czs-github-logo.svg&quot;)"></a></li><li class="flex_center"><a class="czs-message-l" href="mailto:veryyoung.me@gmail.com" target="_blank" style="background-image:url(&quot;/assets/czs-message-l.svg&quot;)"></a></li><li class="flex_center"><a class="czs-twitter" href="https://twitter.com/0xveryyoung" target="_blank" style="background-image:url(&quot;/assets/czs-twitter.svg&quot;)"></a></li><li style="flex-grow:1"></li><li class="toggle_dark flex_center"><span class="czs-sun" style="background-image:url(&quot;/assets/czs-sun.svg&quot;)"></span><span class="czs-sun-l" style="background-image:url(&quot;/assets/czs-sun-l.svg&quot;)"></span><span class="czs-moon" style="background-image:url(&quot;/assets/czs-moon.svg&quot;)"></span><span class="czs-moon-l" style="background-image:url(&quot;/assets/czs-moon-l.svg&quot;)"></span></li></ul><nav><ul class="menu list_style_none"><li><a class="flex_center" href="/"><span class="czs-home-l" style="background-image:url(&quot;/assets/czs-home-l.svg&quot;)"></span>Home</a></li><li><a class="flex_center" href="/tags/"><span class="czs-tag-l" style="background-image:url(&quot;/assets/czs-tag-l.svg&quot;)"></span>Tags</a></li><li><a class="flex_center" href="/about/"><span class="czs-about-l" style="background-image:url(&quot;/assets/czs-about-l.svg&quot;)"></span>About</a></li></ul></nav></div><nav class="toc"><ol><li><a href="#%E5%89%8D%E8%A8%80">前言</a></li><li><a href="#%E7%AE%80%E4%BB%8B">简介</a></li><li><a href="#%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84">代码结构</a><ol><li><a href="#l2geth">l2geth:</a></li><li><a href="#contracts">contracts：</a></li><li><a href="#data-transport-layer">data-transport-layer：</a></li><li><a href="#batch-submitter">batch-submitter：</a></li><li><a href="#message-relayer">message-relayer：</a></li></ol></li><li><a href="#%E4%B8%BB%E8%A6%81%E6%B5%81%E7%A8%8B">主要流程</a></li><li><a href="#zk-rollup-%E7%AE%80%E5%8D%95%E4%BB%8B%E7%BB%8D">zk-rollup 简单介绍</a></li><li><a href="#op-%E4%BC%98%E7%BC%BA%E7%82%B9">OP 优缺点</a></li><li><a href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">参考资料</a></li></ol></nav></aside><section class="main"><h1>Optimistic Rollup 原理</h1><div class="main_post_meta"><time dateTime="Thu Jun 22 2023 00:00:00 GMT+0000 (Coordinated Universal Time)">2023-06-22</time> · veryyoung</div><article><h2 id="%E5%89%8D%E8%A8%80">前言<a class="anchor" href="#%E5%89%8D%E8%A8%80">§</a></h2>
<p>21 年的时候有幸帮一家基于 Optimistic Rollup 的 layer2 团队做过一段时间的事情，时间久了都快忘记了。最近工作不太忙，抽空梳理下。</p>
<h2 id="%E7%AE%80%E4%BB%8B">简介<a class="anchor" href="#%E7%AE%80%E4%BB%8B">§</a></h2>
<p>Layer2 Rollup 是用来做以太坊吞吐量扩容的典型方案，使用 Rollup 可以让交易发生在二层，同时使用以太坊一层来验证二层执行的安全性。</p>
<p>Optimistic Rollup 顾名思义，就是乐观的认为交易是有效的，除非有人提出欺诈证明。</p>
<p>二层上的用户将交易提交给排序者 Sequencer，Sequencer 在二层区块链上执行交易，并定时将交易的 Merkle tree 和状态根提交给一层。</p>
<p>Sequencer 的节点需要质押代币来执行，交易提交后会有一个时间窗口(一般是七天)，在时间窗口内任何人都可以提交欺诈证明。欺诈证明一旦成立会扣除对应 Sequencer 的奖励，同时给与提交欺诈证明的人奖励。</p>
<h2 id="%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84">代码结构<a class="anchor" href="#%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84">§</a></h2>
<p>代码分为如下五层:</p>
<ul>
<li>l2geth</li>
<li>contracts</li>
<li>data-transport-layer</li>
<li>batch-submitter</li>
<li>message-relayer</li>
</ul>
<h3 id="l2geth">l2geth:<a class="anchor" href="#l2geth">§</a></h3>
<p>l2geth 是 go-ethereum 的 fork，同时里面增加了 rollup 包，实现了 layer2 上的两种角色：Sequencer 和 Verifier。</p>
<p>Sequencer: 监听 layer1 的跨域消息，并且将交易改为 OVMMessage 到 OVM 中运行。</p>
<p>Verifier: 验证 layer2 上的 Sequencer 提交的交易的正确性。</p>
<h3 id="contracts">contracts：<a class="anchor" href="#contracts">§</a></h3>
<p>包含 layer1 和 layer2 上的合约。</p>
<h3 id="data-transport-layer">data-transport-layer：<a class="anchor" href="#data-transport-layer">§</a></h3>
<p>通过 RPC 访问 layer1 的 RPC 接口，获取 layer1 上的合约事件，并存储在本地，提供接口供 l2geth 来获取时间。</p>
<h3 id="batch-submitter">batch-submitter：<a class="anchor" href="#batch-submitter">§</a></h3>
<p>定时将交易的 Merkle tree 和状态根提交给一层。</p>
<h3 id="message-relayer">message-relayer：<a class="anchor" href="#message-relayer">§</a></h3>
<p>监听 layer2 上的 SentMessages 事件，在 layer1 上调用 OVM_L1CrossDomainMessenger 合约的 relayMessage 方法，在一层上执行对应的操作，来完成跨域转账。</p>
<h2 id="%E4%B8%BB%E8%A6%81%E6%B5%81%E7%A8%8B">主要流程<a class="anchor" href="#%E4%B8%BB%E8%A6%81%E6%B5%81%E7%A8%8B">§</a></h2>
<p>layer2 上执行交易，通过 batch-submitter 提交到 layer1 合约上，通过事件的方式记录下来。data-transport-layer 从 layer1 上监听事件，存储在本地，提供 RPC 接口给 layer2，layer2 和已经确定的交易进行比较，如果不一样需要提交给 layer1 上的验证者进行验证。</p>
<h2 id="zk-rollup-%E7%AE%80%E5%8D%95%E4%BB%8B%E7%BB%8D">zk-rollup 简单介绍<a class="anchor" href="#zk-rollup-%E7%AE%80%E5%8D%95%E4%BB%8B%E7%BB%8D">§</a></h2>
<p>顾名思义，通过零知识证明验证来进行 Rollups 环节。 ZK 生成一个简洁的证明来确保批次中的交易有效性，无需逐一检查每笔交易。</p>
<p>因为生成零知识证明的难度过高，目前仅支持简单的转账交易。</p>
<h2 id="op-%E4%BC%98%E7%BC%BA%E7%82%B9">OP 优缺点<a class="anchor" href="#op-%E4%BC%98%E7%BC%BA%E7%82%B9">§</a></h2>
<p>优点：</p>
<ul>
<li>吞吐量高</li>
<li>EVM 兼容，迁移成本低</li>
</ul>
<p>缺点：</p>
<ul>
<li>排序器是中心化的，会影响交易顺序的公平性</li>
<li>因为有锁定期，提币时间长</li>
<li>有验证者作恶的风险成本</li>
</ul>
<h2 id="%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">参考资料<a class="anchor" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">§</a></h2>
<ul>
<li><a href="https://ethereum.org/en/developers/docs/scaling/optimistic-rollups/">OPTIMISTIC ROLLUPS</a></li>
<li><a href="https://github.com/ethereum-optimism">Optimism</a></li>
</ul></article></section><footer>Powered by&amp;nbsp;<a href="https://github.com/xcatliu/pagic" target="_blank">Pagic</a></footer><script src="https://cdn.pagic.org/react@18.2.0/umd/react.production.min.js"></script><script src="https://cdn.pagic.org/react-dom@18.2.0/umd/react-dom.production.min.js"></script><script type="module" src="/index.js"></script></body></html>